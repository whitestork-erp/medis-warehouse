[
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<div class=\"container-fluid mt-4\">\n  <div class=\"row\">\n    <div class=\"col-md-6 offset-md-3\">\n      <div class=\"card\">\n        <div class=\"card-body text-center\">\n          <h4>Start Picking</h4>\n\n          <!--  barcode input  -->\n          <input type=\"text\"\n                 id=\"scanBarcode\"\n                 class=\"form-control form-control-lg\"\n                 placeholder=\"Scan barcode…\"\n                 autocomplete=\"off\"\n                 autofocus>\n\n          <!--  feedback  -->\n          <div id=\"scanFeedback\" class=\"mt-3\"></div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n\n",
  "modified": "2025-09-08 11:21:03.551147",
  "name": "Picker Scanning Screen",
  "private": 0,
  "roles": [],
  "script": "\nconst fb = root_element.getElementById('scanFeedback');\n\nroot_element.querySelector('#scanBarcode').addEventListener('keydown', function(event) {\n  event.stopPropagation();\n  fb.innerHTML = ''\n  if (event.key === 'Enter') {\n    event.preventDefault();\n    updateWorkflowState(event);\n  }\n});\nfunction updateWorkflowState(event) {\nvar barcode = root_element.querySelector('#scanBarcode').value.trim();\nconst box = root_element.getElementById('scanBarcode');\n\nif (!barcode) return;\nfrappe.call({\n        method: 'medis.api.picker_utils.transition_to_picking',\n        args: { invoice_barcode: barcode },\n        callback: r => {\n          box.value = '';\n          fb.innerHTML = `<span class=\"${r.message.ok ? 'text-success' : 'text-danger'}\">${r.message.msg}</span>`;\n          r.message.ok ? frappe.utils.play_sound(\"submit\"):frappe.utils.play_sound(\"error\");\n        }\n      });\n      \n}",
  "style": "#scanFeedback { font-weight:bold; }"
 },
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<div class=\"container-fluid mt-4\" id=\"controlling-container\">\r\n  <!-- 1. Invoice scanner  -->\r\n  <div class=\"row\">\r\n    <div class=\"col-md-6 offset-md-3\">\r\n      <div class=\"card\">\r\n        <div class=\"card-body text-center\">\r\n          <h4>Start Controlling</h4>\r\n\r\n          <!--<div class=\"col-md-6 offset-md-3\">-->\r\n          <input\r\n            type=\"text\"\r\n            id=\"invoiceBarcode\"\r\n            class=\"form-control form-control-lg\"\r\n            placeholder=\"Scan barcode…\"\r\n            autocomplete=\"off\"\r\n            autofocus\r\n          />\r\n          <div id=\"invoiceFeedback\" class=\"mt-3\"></div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<!-- Invoice card (read-only) + Delete -->\r\n<div class=\"row mt-3\">\r\n  <div class=\"col-md-8 offset-md-2\">\r\n    <div id=\"invoiceCard\" class=\"card d-none\">\r\n      <div class=\"card-body\">\r\n        <div class=\"d-flex justify-content-between align-items-center\">\r\n          <h5 class=\"card-title mb-0\">\r\n            Invoice <span id=\"invName\"></span>\r\n          </h5>\r\n          <button id=\"btnCancelControl\" class=\"btn btn-primary\">\r\n            Cancel Control\r\n          </button>\r\n        </div>\r\n\r\n        <p class=\"mb-1 mt-2\">\r\n          <strong>Customer:</strong> <span id=\"invCustomer\"></span>\r\n        </p>\r\n        <p class=\"mb-1\">\r\n          <strong>Status:</strong> <span id=\"invStatus\"></span>\r\n        </p>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<!-- 2. Item scanner (only visible after invoice) -->\r\n<div class=\"row mt-4 d-none\" id=\"itemSection\">\r\n  <div class=\"col-md-6 offset-md-3\">\r\n    <input\r\n      type=\"text\"\r\n      id=\"itemBarcode\"\r\n      class=\"form-control form-control-lg\"\r\n      placeholder=\"Scan item barcode …\"\r\n      autocomplete=\"off\"\r\n      disabled\r\n    />\r\n    <div id=\"itemFeedback\" class=\"mt-2\"></div>\r\n  </div>\r\n</div>\r\n\r\n<!-- 3. Scanned-items table -->\r\n<div class=\"row mt-4 d-none\" id=\"tableSection\">\r\n  <div class=\"col-md-8 offset-md-2\">\r\n    <table class=\"table table-bordered\" id=\"scanTable\">\r\n      <thead>\r\n        <tr>\r\n          <th>Item Code</th>\r\n          <th>Item Name</th>\r\n          <th>Required&nbsp;Qty</th>\r\n          <th>Scanned&nbsp;Qty</th>\r\n          <th style=\"width:90px\">Action</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody></tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n\r\n<!-- 4. Compare button -->\r\n<div class=\"row mt-3 d-none\" id=\"compareSection\">\r\n  <div class=\"col-md-8 offset-md-2 text-center\">\r\n    <button id=\"btnCompare\" class=\"btn btn-primary\">\r\n      Compare with Invoice\r\n    </button>\r\n    <div id=\"compareResult\" class=\"mt-3\"></div>\r\n    <!-- 4-bis  Comparison tables -->\r\n    <div class=\"row mt-4 d-none\" id=\"comparisonSection\">\r\n      <div class=\"col-md-10 offset-md-1\">\r\n        <!--  Missing items table  -->\r\n        <div class=\"row mt-4 d-none\" id=\"missingSection\">\r\n          <div class=\"col-md-8 offset-md-2\">\r\n            <h5>Comparison result</h5>\r\n            <h6 class=\"text-danger\">Missing items</h6>\r\n            <table class=\"table table-bordered\" id=\"missingTable\">\r\n              <thead>\r\n                <tr>\r\n                  <th>Item Code</th>\r\n                  <th>Item Name</th>\r\n                  <th>Required&nbsp;Qty</th>\r\n                  <th>Scanned&nbsp;Qty</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody></tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <button id=\"btnClearScanned\" class=\"btn btn-secondary btn-sm\">\r\n      Clear scanned list\r\n    </button>\r\n  </div>\r\n</div>\r\n<!--</div>-->\r\n\r\n<!-- 5. Pack button -->\r\n<div class=\"row mt-3 d-none\" id=\"packSection\">\r\n  <div class=\"col-md-8 offset-md-2 text-center\">\r\n    <button id=\"btnPack\" class=\"btn btn-success\">Pack</button>\r\n  </div>\r\n</div>\r\n",
  "modified": "2025-09-16 10:19:02.230475",
  "name": "Controller Scanning Screen",
  "private": 0,
  "roles": [],
  "script": "let keyGuard; // will hold the listener reference\nlet scannedRowNameMap = new Map();\n// --- elements ----\n\nlet invoiceDoc = null;\nlet scannedMap = new Map(); // {item_code: qty}\nconst rows = [];\nconst invBox = root_element.getElementById(\"invoiceBarcode\");\nconst invFb = root_element.getElementById(\"invoiceFeedback\");\nconst itemBox = root_element.getElementById(\"itemBarcode\");\nconst itemFb = root_element.getElementById(\"itemFeedback\");\nconst tbody = root_element.querySelector(\"#scanTable tbody\");\nconst missingSection = root_element.getElementById(\"#missingTable tbody\");\nconst compareResult = root_element.getElementById(\"compareResult\");\nconst packSection = root_element.getElementById(\"packSection\");\nconst packBtn = root_element.getElementById(\"btnPack\");\nconst controllingBox = root_element.getElementById(\"controlling-container\");\nconst btnClearScanned = root_element.getElementById(\"btnClearScanned\");\n\n(function () {\n  // prevent global search shortcuts\n  [invBox, itemBox].forEach((box) =>\n    box.addEventListener(\"keydown\", (e) => {\n      e.stopPropagation();\n      if (e.key === \"/\" || (e.ctrlKey && e.key.toLowerCase() === \"k\")) {\n        e.preventDefault();\n        e.stopImmediatePropagation();\n      }\n    })\n  );\n\n  // ---------- 1. invoice scan ----------\n  invBox.addEventListener(\"keydown\", (event) => {\n    if (event.key !== \"Enter\") return;\n\n    event.preventDefault();\n    invFb.innerHTML = \"\";\n    fetchInvoice(invBox.value.trim());\n  });\n\n  function fetchInvoice(invoice) {\n    if (!invoice) return;\n    frappe.call({\n      method: \"medis.api.controller_utils.start_invoice_controlling\",\n      args: { invoice },\n      callback: (r) => {\n        if (r.message.success) {\n          controllingBox.hidden = true;\n          invoiceDoc = r.message.doc;\n          renderInvoice(r.message.doc);\n          enableItemSection();\n          toggleClearButton();\n        } else {\n          invFb.innerHTML = `<span class=\"${\n            r.message.success ? \"text-success\" : \"text-danger\"\n          }\">${r.message.msg}</span>`;\n          frappe.utils.play_sound(\"error\");\n        }\n        invBox.value = \"\";\n      },\n    });\n  }\n\n  function renderInvoice(doc) {\n    root_element.getElementById(\"invName\").textContent = doc.name;\n    root_element.getElementById(\"invCustomer\").textContent = doc.customer;\n    root_element.getElementById(\"invStatus\").textContent = doc.workflow_state;\n    root_element.getElementById(\"invoiceCard\").classList.remove(\"d-none\");\n    invBox.hidden = true;\n  }\n\n  function enableItemSection() {\n    root_element.getElementById(\"itemSection\").classList.remove(\"d-none\");\n    root_element.getElementById(\"tableSection\").classList.remove(\"d-none\");\n    root_element.getElementById(\"compareSection\").classList.remove(\"d-none\");\n    itemBox.disabled = false;\n    itemBox.focus();\n    blockGlobalKeys();\n    tbody.addEventListener(\"keydown\", (e) => {\n      if (\n        e.target.classList.contains(\"qty-input\") &&\n        (e.key === \"Enter\" || e.key === \"Tab\")\n      ) {\n        e.preventDefault();\n        itemBox.focus();\n      }\n    });\n\n    tbody.addEventListener(\"change\", (e) => {\n      if (e.target.classList.contains(\"qty-input\")) {\n        itemBox.focus();\n      }\n    });\n  }\n\n  root_element.addEventListener(\"click\", (e) => {\n    if (!e.target.classList.contains(\"btn-remove\")) return;\n    const code = e.target.dataset.code;\n    scannedMap.delete(code);\n    e.target.closest(\"tr\").remove();\n    toggleClearButton();\n  });\n\n  // Clear entire scanned list\n  root_element\n    .getElementById(\"btnClearScanned\")\n    .addEventListener(\"click\", () => {\n      const d = new frappe.ui.Dialog({\n        title: \"Clear Scanned List\",\n        fields: [\n          {\n            label: \"Are you sure you want to clear scanned list?\",\n            fieldtype: \"HTML\",\n            options:\n              \"<p>This will clear the invoice and all scanned items.</p>\",\n          },\n        ],\n        primary_action_label: \"Yes, Clear\",\n        primary_action: () => {\n          // Clear all scanned data\n          scannedMap.clear();\n          scannedRowNameMap.clear();\n          rows.length = 0; // Clear the rows array\n\n          // Clear UI elements\n          tbody.innerHTML = \"\";\n          itemFb.innerHTML = \"\";\n\n          // Clear missing table and comparison results\n          const mTbody = root_element.querySelector(\"#missingTable tbody\");\n          if (mTbody) mTbody.innerHTML = \"\";\n          compareResult.innerHTML = \"\";\n\n          // Hide comparison sections\n          root_element\n            .getElementById(\"comparisonSection\")\n            .classList.add(\"d-none\");\n          root_element.getElementById(\"missingSection\").classList.add(\"d-none\");\n          togglePackButton(false);\n          toggleClearButton();\n          88;\n          itemBox.focus();\n          d.hide();\n        },\n\n        secondary_action_label: \"No\",\n        secondary_action: () => d.hide(),\n      });\n      d.show();\n    });\n\n  // ---------- 2. item scan ----------\n  itemBox.addEventListener(\"keydown\", (e) => {\n    if (e.key !== \"Enter\") return;\n    e.preventDefault();\n    lookupItemByBarcode(itemBox.value.trim());\n    itemFb.innerHTML = \"\";\n  });\n\n  function lookupItemByBarcode(barcode) {\n    if (!barcode) return;\n    frappe.call({\n      method: \"medis.api.controller_utils.get_item_by_barcode\",\n      args: { barcode },\n      callback: (r) => {\n        if (r.message.success) {\n          addOrUpdateRow(r.message.item_code, r.message.item_name);\n        } else {\n          itemFb.innerHTML = `<span class=\"text-danger\">${r.message.msg}</span>`;\n          frappe.utils.play_sound(\"error\");\n        }\n        itemBox.value = \"\";\n      },\n    });\n  }\n\n  function addOrUpdateRow(code, name) {\n    // Check for undefined values\n    if (!code || !name) {\n      return;\n    }\n\n    scannedRowNameMap.set(code, name);\n    const currentQty = scannedMap.get(code) || 0;\n    const newQty = currentQty + 1;\n    scannedMap.set(code, newQty);\n\n    let row = tbody.querySelector(`tr[data-code=\"${code}\"]`);\n\n    if (row) {\n      row.querySelector(\".qty-input\").value = newQty;\n    } else {\n      row = document.createElement(\"tr\");\n      row.dataset.code = code;\n      row.innerHTML = `\n        <td>${code}</td>\n        <td>${name}</td>\n        <td> </td>\n        <td>\n          <input type=\"number\" min=\"1\" value=\"${newQty}\" class=\"form-control qty-input\"\n                style=\"width:80px;\" autofocus>\n        </td>\n        <td>\n        <button class=\"btn btn-sm btn-outline-secondary btn-remove\"\n                data-code=\"${code}\" title=\"Remove\">\n          Clear\n        </button>\n      </td>`;\n      tbody.appendChild(row);\n      toggleClearButton();\n    }\n\n    row.querySelector(\".qty-input\").focus();\n    row.querySelector(\".qty-input\").addEventListener(\"change\", (e) => {\n      const newQty = parseInt(e.target.value || 0);\n      scannedMap.set(code, newQty);\n    });\n  }\n\n  // ---------- 3. delete invoice ----------\n  root_element\n    .getElementById(\"btnCancelControl\")\n    .addEventListener(\"click\", () => {\n      const d = new frappe.ui.Dialog({\n        title: \"Cancel Control\",\n        fields: [\n          {\n            label: \"Are you sure you want to cancel the current control?\",\n            fieldtype: \"HTML\",\n            options:\n              \"<p>This will clear the invoice and all scanned items.</p>\",\n          },\n        ],\n        primary_action_label: \"Yes, Cancel\",\n        primary_action: () => {\n          // ---- existing reset code ----\n          frappe.call({\n            method: \"medis.api.controller_utils.cancel_control\",\n            args: {\n              invoice: invoiceDoc.name,\n            },\n            callback: (r) => {\n              if (r.message.success) {\n                // Clear all state variables\n                invoiceDoc = null;\n                scannedMap.clear();\n                scannedRowNameMap.clear();\n                rows.length = 0; // Clear the rows array\n\n                // Clear all UI elements\n                tbody.innerHTML = \"\";\n                compareResult.innerHTML = \"\";\n                invFb.innerHTML = \"\";\n                itemFb.innerHTML = \"\";\n\n                // Clear missing table if it exists\n                const mTbody = root_element.querySelector(\n                  \"#missingTable tbody\"\n                );\n                if (mTbody) mTbody.innerHTML = \"\";\n\n                // Hide all sections\n                root_element\n                  .getElementById(\"invoiceCard\")\n                  .classList.add(\"d-none\");\n                root_element\n                  .getElementById(\"itemSection\")\n                  .classList.add(\"d-none\");\n                root_element\n                  .getElementById(\"tableSection\")\n                  .classList.add(\"d-none\");\n                root_element\n                  .getElementById(\"compareSection\")\n                  .classList.add(\"d-none\");\n                root_element\n                  .getElementById(\"comparisonSection\")\n                  .classList.add(\"d-none\");\n                root_element\n                  .getElementById(\"missingSection\")\n                  .classList.add(\"d-none\");\n                togglePackButton(false);\n\n                // Reset input fields\n                invBox.value = \"\";\n                itemBox.value = \"\";\n                invBox.hidden = false;\n                itemBox.disabled = true;\n                controllingBox.hidden = false;\n\n                // Reset focus and unblock keys\n                invBox.focus();\n                unblockGlobalKeys();\n                toggleClearButton();\n\n                d.hide();\n                frappe.utils.play_sound(\"submit\");\n              } else {\n                frappe.msgprint(\n                  r.message.error || \"Error while Canceling Control\"\n                );\n              }\n            },\n          });\n        },\n        secondary_action_label: \"No\",\n        secondary_action: () => d.hide(),\n      });\n      d.show();\n    });\n\n  function clearPage() {\n    // Clear all state variables\n    invoiceDoc = null;\n    scannedMap.clear();\n    scannedRowNameMap.clear();\n    rows.length = 0; // Clear the rows array\n\n    // Clear all UI elements\n    tbody.innerHTML = \"\";\n    compareResult.innerHTML = \"\";\n    invFb.innerHTML = \"\";\n    itemFb.innerHTML = \"\";\n\n    // Clear missing table if it exists\n    const mTbody = root_element.querySelector(\"#missingTable tbody\");\n    if (mTbody) mTbody.innerHTML = \"\";\n\n    // Hide all sections\n    root_element.getElementById(\"invoiceCard\").classList.add(\"d-none\");\n    root_element.getElementById(\"itemSection\").classList.add(\"d-none\");\n    root_element.getElementById(\"tableSection\").classList.add(\"d-none\");\n    root_element.getElementById(\"compareSection\").classList.add(\"d-none\");\n    root_element.getElementById(\"comparisonSection\").classList.add(\"d-none\");\n    root_element.getElementById(\"missingSection\").classList.add(\"d-none\");\n    togglePackButton(false);\n\n    // Reset input fields\n    invBox.value = \"\";\n    itemBox.value = \"\";\n    invBox.hidden = false;\n    itemBox.disabled = true;\n    controllingBox.hidden = false;\n\n    // Reset focus and unblock keys\n    invBox.focus();\n    unblockGlobalKeys();\n    toggleClearButton();\n  }\n\n  // ---------- 4. compare ----------\n  root_element\n    .getElementById(\"btnCompare\")\n    .addEventListener(\"click\", compareWithInvoice);\n\n  function compareWithInvoice() {\n    if (!invoiceDoc) return;\n    syncQtyFromTable();\n\n    // Clear the rows array before building new comparison data\n    rows.length = 0;\n\n    // Build required map\n    const requiredMap = new Map();\n    invoiceDoc.items.forEach((it) =>\n      requiredMap.set(it.item_code, { qty: it.qty, name: it.item_name })\n    );\n\n    // ------------------------------------------------------------------\n    // 1) Missing items table\n    // ------------------------------------------------------------------\n    const mSection = root_element.getElementById(\"missingSection\");\n    const mTbody = root_element.querySelector(\"#missingTable tbody\");\n\n    mTbody.innerHTML = \"\";\n    requiredMap.forEach((v, code) => {\n      if (!scannedMap.has(code)) {\n        const tr = document.createElement(\"tr\");\n        tr.innerHTML = `\n        <td>${code}</td>\n        <td>${v.name}</td>\n        <td>${v.qty}</td>\n        <td>0</td>`;\n        mTbody.appendChild(tr);\n      }\n    });\n    mSection.classList.toggle(\"d-none\", mTbody.rows.length === 0);\n\n    // ------------------------------------------------------------------\n    // 2) Scanned items table  (extra -> mismatched -> ok)\n    // ------------------------------------------------------------------\n\n    scannedMap.forEach((scannedQty, code) => {\n      // Skip undefined entries\n      if (!code || code === \"undefined\") {\n        return;\n      }\n\n      const req = requiredMap.get(code);\n      const row = {\n        code,\n        name: req ? req.name : scannedRowNameMap.get(code) || \"\", // fallback if needed\n        required: req ? req.qty : 0,\n        scanned: scannedQty,\n        type: !req ? \"extra\" : scannedQty !== req.qty ? \"mismatch\" : \"ok\",\n      };\n      rows.push(row);\n    });\n\n    // sort: extra first, then mismatch, then ok\n    rows.sort((a, b) => {\n      const weight = { extra: 0, mismatch: 1, ok: 2 };\n      return weight[a.type] - weight[b.type];\n    });\n\n    const sTbody = root_element.querySelector(\"#scanTable tbody\");\n    sTbody.innerHTML = \"\";\n    rows.forEach((r) => {\n      const tr = document.createElement(\"tr\");\n      tr.classList.add(`row-${r.type}`); // colour class\n      tr.dataset.code = r.code; // Make sure the data-code is set\n      tr.innerHTML = `\n      <td>${r.code}</td>\n      <td>${r.name}</td>\n      <td>${r.required}</td>\n      <td>\n        <input type=\"number\" min=\"0\" value=\"${r.scanned}\"\n               class=\"form-control form-control-sm qty-input\" style=\"width:80px\">\n      </td>\n      <td>\n        <button class=\"btn btn-sm btn-outline-secondary btn-remove\"\n                data-code=\"${r.code}\" title=\"Remove\">Clear</button>\n      </td>`;\n      sTbody.appendChild(tr);\n\n      // Add change event listener to the input field\n      const inputElement = tr.querySelector(\".qty-input\");\n      inputElement.addEventListener(\"change\", (e) => {\n        const newQty = parseInt(e.target.value) || 0;\n        scannedMap.set(r.code, newQty);\n      });\n    });\n\n    // ------------------------------------------------------------------\n    // 3) Show section & toggle Pack button\n    // ------------------------------------------------------------------\n    root_element.getElementById(\"comparisonSection\").classList.remove(\"d-none\");\n    root_element\n      .getElementById(\"comparisonSection\")\n      .scrollIntoView({ behavior: \"smooth\" });\n\n    const missingCount = mTbody.rows.length;\n    const mismatchCount = sTbody.querySelectorAll(\n      \"tr.row-mismatch, tr.row-extra\"\n    ).length;\n    togglePackButton(missingCount === 0 && mismatchCount === 0);\n  }\n\n  packBtn.addEventListener(\"click\", () => {\n    const d = new frappe.ui.Dialog({\n      title: \"Confirm Packing\",\n      fields: [\n        {\n          label: \"Number of Packages\",\n          fieldname: \"packages\",\n          fieldtype: \"Int\",\n          reqd: 1,\n          default: 1,\n        },\n      ],\n      primary_action_label: \"Print & Save\",\n      primary_action: (values) => {\n                      var printService = new frappe.silent_print.WebSocketPrinter();\n        frappe.call({\n          method: \"medis.api.controller_utils.pack_invoice\",\n          args: {\n            invoice: invoiceDoc.name,\n            packages: values.packages,\n            // items: Object.fromEntries(scannedMap), // {item_code: qty}\n          },\n          callback: async (r) => {\n            if (r.message.success) {\n              frappe.show_alert({\n                message: \"Invoice packed successfully\",\n                indicator: \"green\",\n              });\n              let zpl = [];\n              for (let i = 1; i <= values.packages; i++) {\n                zpl.push(`^XA\n                                    ^FO50,50^A0N,40,40^FDInvoice: ${invoiceDoc.name}^FS\n                                    ^FO50,120^A0N,40,40^FDPackage: ${i}/${values.packages}^FS\n                                    ^FO50,200^BY2\n                                    ^BCN,100,Y,N,N\n                                    ^FD${invoiceDoc.name}^FS\n                                    ^XZ`);\n              }\n\n              const payload = {\n                type: \"ZPL Printer\",\n                raw_content: btoa(zpl),\n              };\n\n              printService.submit(payload);\n              d.hide();\n              // optionally reset the whole screen\n              frappe.utils.play_sound(\"submit\");\n              togglePackButton(false);\n              // root_element.getElementById(\"btnDeleteInvoice\").click(F);\n              clearPage();\n            } else {\n              frappe.msgprint(r.message.msg || \"Error while packing\");\n            }\n          },\n        });\n      },\n    });\n    d.show();\n  });\n\n  function togglePackButton(ok) {\n    if (ok) packSection.classList.remove(\"d-none\");\n    else packSection.classList.add(\"d-none\");\n  }\n  function syncQtyFromTable() {\n    // update scannedMap with whatever the user has typed\n    tbody.querySelectorAll(\"tr\").forEach((tr) => {\n      const code = tr.dataset.code;\n      const inputElement = tr.querySelector(\".qty-input\");\n\n      // Safety checks\n      if (!code || !inputElement) {\n        return;\n      }\n\n      const val = parseInt(inputElement.value) || 0;\n      if (val > 0) {\n        scannedMap.set(code, val);\n      } else {\n        // Remove items with 0 or invalid quantity\n        scannedMap.delete(code);\n      }\n    });\n  }\n})();\n\nfunction blockGlobalKeys() {\n  keyGuard = (e) => {\n    // numbers on the numpad and main keyboard\n    if (e.code.startsWith(\"Digit\") || e.code.startsWith(\"Numpad\")) {\n      e.stopImmediatePropagation();\n    }\n  };\n  document.addEventListener(\"keydown\", keyGuard, true); // use-capture\n}\n\nfunction unblockGlobalKeys() {\n  if (keyGuard) {\n    document.removeEventListener(\"keydown\", keyGuard, true);\n    keyGuard = null;\n  }\n}\n\nfunction toggleClearButton() {\n  const hasRows = tbody.rows.length > 0;\n  btnClearScanned.classList.toggle(\"d-none\", !hasRows);\n}\n\nfrappe.provide(\"frappe.silent_print\");\nfrappe.silent_print.WebSocketPrinter = function (options) {\n  console.log(\"--------------------- WebSocketPrinter ------------------\");\n  var defaults = {\n    url: \"ws://127.0.0.1:12212/printer\",\n    onConnect: function () {},\n    onDisconnect: function () {},\n    onUpdate: function () {},\n  };\n\n  var settings = Object.assign({}, defaults, options);\n  var websocket;\n  var connected = false;\n\n  var onMessage = function (evt) {\n    settings.onUpdate(evt.data);\n  };\n\n  var onConnect = function () {\n    connected = true;\n    settings.onConnect();\n  };\n\n  var onDisconnect = function () {\n    connected = false;\n    settings.onDisconnect();\n    reconnect();\n  };\n\n  var onError = function () {\n    if (frappe.whb == undefined) {\n      frappe.msgprint(\n        \"Connection to the printer could not be established. Please verify that the  <a href='https://github.com/imTigger/webapp-hardware-bridge' target='_blank'>WebApp Hardware Bridge</a> is running.\"\n      );\n      frappe.whb = true;\n    }\n  };\n\n  var connect = function () {\n    websocket = new WebSocket(settings.url);\n    websocket.onopen = onConnect;\n    websocket.onclose = onDisconnect;\n    websocket.onmessage = onMessage;\n    websocket.onerror = onError;\n  };\n\n  var reconnect = function () {\n    connect();\n  };\n\n  this.submit = function (data) {\n    console.log(\n    );\n    if (Array.isArray(data)) {\n      data.forEach(function (element) {\n        websocket.send(JSON.stringify(element));\n      });\n    } else {\n      websocket.send(JSON.stringify(data));\n    }\n  };\n\n  this.isConnected = function () {\n    return connected;\n  };\n\n  connect();\n};\n",
  "style": "  .row-extra {\n    background-color: #fff3cd !important; /* Light yellow background */\n  }\n  \n  .row-mismatch {\n    background-color: #f8d7da !important; /* Light red background */\n  }\n  \n  .row-ok {\n    background-color: #d4edda !important; /* Light green background */\n  }\n  \n  /* Missing items table styling */\n  #missingTable tbody tr {\n    background-color: #f8d7da !important;\n  }"
 },
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<div class=\"container-fluid mt-4\">\n  <div class=\"row\">\n    <div class=\"col-md-6 offset-md-3\">\n      <div class=\"card\">\n        <div class=\"card-body text-center\">\n          <h4>Archive</h4>\n\n          <!--  barcode input  -->\n          <input type=\"text\"\n                 id=\"scanBarcode\"\n                 class=\"form-control form-control-lg\"\n                 placeholder=\"Scan barcode…\"\n                 autocomplete=\"off\"\n                 autofocus>\n\n          <!--  feedback  -->\n          <div id=\"scanFeedback\" class=\"mt-3\"></div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n\n",
  "modified": "2025-09-22 10:27:11.166017",
  "name": "Archive Screen",
  "private": 0,
  "roles": [],
  "script": "\nconst fb = root_element.getElementById('scanFeedback');\n\nroot_element.querySelector('#scanBarcode').addEventListener('keydown', function(event) {\n  event.stopPropagation();\n  fb.innerHTML = ''\n  if (event.key === 'Enter') {\n    event.preventDefault();\n    updateWorkflowState(event);\n  }\n});\nfunction updateWorkflowState(event) {\nvar barcode = root_element.querySelector('#scanBarcode').value.trim();\nconst box = root_element.getElementById('scanBarcode');\n\nif (!barcode) return;\nfrappe.call({\n        method: 'medis.api.archive_utils.transition_to_archived',\n        args: { invoice_name: barcode },\n        callback: r => {\n          box.value = '';\n          fb.innerHTML = `<span class=\"${r.message.ok ? 'text-success' : 'text-danger'}\">${r.message.msg}</span>`;\n          r.message.ok ? frappe.utils.play_sound(\"submit\"):frappe.utils.play_sound(\"error\");\n        }\n      });\n      \n}",
  "style": "#scanFeedback { font-weight:bold; }"
 }
]